# Python Dependency Scanning - Complete Guide

## Overview

The security-checker tool provides comprehensive support for Python dependencies, including **full transitive dependency resolution** when using lock files.

## Supported Python Files

### 1. requirements.txt (Direct Dependencies Only)
- Basic pip requirements file
- **⚠️ Limitation**: Only scans direct dependencies listed in the file
- Does NOT resolve transitive dependencies
- Use for simple projects or as fallback

**Example:**
```txt
django==2.2.0
requests==2.25.0
flask==1.1.1
```

### 2. Pipfile.lock (Full Transitive Dependencies) ✅
- Generated by Pipenv
- **✅ Includes**: All transitive dependencies with exact versions and hashes
- Provides complete dependency graph
- Best for Pipenv projects

**Generate Pipfile.lock:**
```bash
pipenv lock
```

### 3. poetry.lock (Full Transitive Dependencies) ✅ NEW!
- Generated by Poetry
- **✅ Includes**: All transitive dependencies with exact versions and hashes
- Provides complete dependency graph
- Best for Poetry projects

**Generate poetry.lock:**
```bash
poetry lock
```

## Lock File Priority

When both requirements.txt and a lock file are provided, the lock file takes priority:

| Files Provided | File Used | Reason |
|----------------|-----------|--------|
| `requirements.txt` only | requirements.txt | Only option, scans direct deps |
| `Pipfile.lock` only | Pipfile.lock | ✅ Full transitive deps |
| `poetry.lock` only | poetry.lock | ✅ Full transitive deps |
| `requirements.txt` + `Pipfile.lock` | **Pipfile.lock** | More complete (transitive deps) |
| `requirements.txt` + `poetry.lock` | **poetry.lock** | More complete (transitive deps) |
| `Pipfile.lock` + `poetry.lock` | **Both** | Different tools, scan both |

## Usage Examples

### Poetry Projects (Recommended)

```bash
# Generate lock file if needed
poetry lock

# Scan all dependencies including transitive ones
security-checker poetry.lock

# With verbose output
security-checker poetry.lock --verbose

# JSON output for CI/CD
security-checker poetry.lock --json
```

### Pipenv Projects

```bash
# Generate lock file if needed
pipenv lock

# Scan all dependencies including transitive ones
security-checker Pipfile.lock

# With verbose output
security-checker Pipfile.lock --verbose
```

### Requirements.txt Only Projects

```bash
# Scan direct dependencies only
security-checker requirements.txt

# Note: This will NOT scan transitive dependencies
# Consider using poetry or pipenv for better security coverage
```

### Mixed Projects

```bash
# Both lock files will be scanned
security-checker Pipfile.lock poetry.lock

# Requirements.txt will be ignored (lock file prioritized)
security-checker requirements.txt poetry.lock
```

## How Transitive Dependencies Are Resolved

### poetry.lock Parser

The `poetryLock.ts` parser extracts all packages from the TOML-formatted lock file:

```toml
[[package]]
name = "django"
version = "2.2.0"
category = "main"

[package.dependencies]
pytz = "*"
sqlparse = ">=0.2.2"

[[package]]
name = "pytz"
version = "2021.1"
category = "main"
```

**Result**: Both `django` and its transitive dependency `pytz` are scanned.

### Pipfile.lock Parser

The `pipfileLock.ts` parser extracts all packages from the JSON-formatted lock file:

```json
{
  "default": {
    "django": {
      "version": "==2.2.0"
    },
    "pytz": {
      "version": "==2021.1"
    }
  }
}
```

**Result**: All packages in both `default` and `develop` sections are scanned.

## Vulnerability Checking Process

For Python packages, the tool checks vulnerabilities using:

### OSV.dev API (Primary Source)
- Ecosystem: `PyPI`
- Coverage: Comprehensive open-source vulnerability database
- Includes: CVE IDs, GHSA IDs, severity scores, fixed versions
- Authentication: Not required

### PyPI Advisory Database (Python-Specific)
- Source: Python Packaging Advisory Database (https://github.com/pypa/advisory-database)
- Coverage: Python-specific vulnerabilities curated by the PyPA team
- Includes: CVE IDs, severity, detailed descriptions, fixed versions
- Authentication: Not required
- Provides additional coverage beyond OSV.dev for Python packages

**Example Query:**
```typescript
{
  package: {
    name: "django",
    ecosystem: "PyPI"
  },
  version: "2.2.0"
}
```

### Vulnerability Report Format

Each vulnerability found includes:
- **Package name**: e.g., "django"
- **Version**: e.g., "2.2.0"
- **Severity**: CRITICAL, HIGH, MODERATE, LOW, UNKNOWN
- **CVE IDs**: e.g., ["CVE-2019-12781"]
- **Description**: Detailed vulnerability description
- **Advisory Links**: URLs to security advisories
- **Fixed Versions**: Versions that address the vulnerability
- **Suggested Upgrade**: Recommended version to upgrade to

## CI/CD Integration

### GitHub Actions for Poetry Projects

```yaml
name: Python Security Check

on: [push, pull_request]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install Poetry
        run: pip install poetry
      
      - name: Generate lock file
        run: poetry lock --no-update
      
      - uses: actions/setup-node@v3
      
      - name: Install security-checker
        run: npm install -g security-checker
      
      - name: Run security scan
        run: security-checker poetry.lock --json > security-report.json
      
      - uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.json
```

### Pre-commit Hook for Python Projects

```bash
#!/bin/bash
# .git/hooks/pre-commit

if [ -f "poetry.lock" ]; then
  echo "🔍 Running security check on poetry.lock..."
  security-checker poetry.lock
elif [ -f "Pipfile.lock" ]; then
  echo "🔍 Running security check on Pipfile.lock..."
  security-checker Pipfile.lock
elif [ -f "requirements.txt" ]; then
  echo "⚠️  Running security check on requirements.txt (direct deps only)..."
  security-checker requirements.txt
fi

if [ $? -ne 0 ]; then
  echo "❌ Security vulnerabilities found!"
  echo "Review and update dependencies before committing."
  # Uncomment to block commits:
  # exit 1
fi
```

## Output Examples

### Human-Readable Output

```
📋 Parsing dependency files...
✓ Parsed 87 dependencies from poetry.lock

🔍 Checking for vulnerabilities...

📊 Results Summary
  Total dependencies scanned: 87
  Vulnerable packages: 3 (3.4%)
  Total vulnerabilities: 5

  Severity breakdown:
    🔴 Critical: 1
    🟠 High: 2
    🟡 Moderate: 2
    🟢 Low: 0

🚨 Vulnerabilities Details

  [CRITICAL] django@2.2.0
    SQL injection vulnerability in Django admin
    CVE IDs: CVE-2020-7471
    Fix available: Upgrade to 2.2.10

  [HIGH] flask@1.1.1
    Denial of Service vulnerability
    CVE IDs: CVE-2019-1010083
    Fix available: Upgrade to 1.1.2

💡 Remediation Summary
  5 out of 5 vulnerabilities have fixes available.

  Recommended actions:
    - Update django to version 2.2.10 or later
    - Update flask to version 1.1.2 or later
```

### JSON Output

```json
{
  "summary": {
    "totalDependencies": 87,
    "vulnerablePackages": 3,
    "percentageVulnerable": 3.4,
    "vulnerabilitiesFound": 5,
    "bySeverity": {
      "critical": 1,
      "high": 2,
      "moderate": 2,
      "low": 0,
      "unknown": 0
    }
  },
  "vulnerabilities": [
    {
      "package": "django",
      "version": "2.2.0",
      "severity": "CRITICAL",
      "description": "SQL injection vulnerability in Django admin",
      "cveIds": ["CVE-2020-7471"],
      "advisoryLinks": ["https://osv.dev/vulnerability/CVE-2020-7471"],
      "fixedVersions": ["2.2.10"],
      "suggestedUpgrade": "2.2.10",
      "source": "OSV"
    }
  ],
  "scannedFiles": [
    {
      "file": "poetry.lock",
      "type": "poetry.lock",
      "dependencyCount": 87
    }
  ]
}
```

## Best Practices

### ✅ DO:
- Use `poetry.lock` or `Pipfile.lock` for complete coverage
- Run security checks in CI/CD pipelines
- Keep lock files up to date
- Address vulnerabilities promptly

### ⚠️ DON'T:
- Rely solely on `requirements.txt` for security scanning
- Ignore transitive dependencies
- Skip lock file generation
- Commit outdated lock files

## Comparison: requirements.txt vs Lock Files

| Feature | requirements.txt | Pipfile.lock | poetry.lock |
|---------|------------------|--------------|-------------|
| Direct Dependencies | ✅ Yes | ✅ Yes | ✅ Yes |
| Transitive Dependencies | ❌ No | ✅ Yes | ✅ Yes |
| Exact Versions | ⚠️ Manual | ✅ Automatic | ✅ Automatic |
| Hashes | ❌ No | ✅ Yes | ✅ Yes |
| Reproducible Builds | ⚠️ Limited | ✅ Yes | ✅ Yes |
| Security Coverage | ⚠️ Partial | ✅ Complete | ✅ Complete |

## Troubleshooting

### "No vulnerabilities found" but expecting some

Make sure you're using a lock file:
```bash
# Instead of:
security-checker requirements.txt

# Use:
security-checker poetry.lock
```

### poetry.lock parsing errors

Verify your poetry.lock is valid:
```bash
poetry check
poetry lock --check
```

### Large number of dependencies

Lock files often include many transitive dependencies. This is normal and ensures complete security coverage.

### Rate limiting from OSV.dev

The tool batches requests (10 at a time) to respect rate limits. For very large projects, scanning may take a few minutes.

## Migration Guide

### From requirements.txt to Poetry

```bash
# 1. Install Poetry
pip install poetry

# 2. Initialize Poetry (if not already done)
poetry init

# 3. Add existing dependencies
cat requirements.txt | xargs poetry add

# 4. Generate lock file
poetry lock

# 5. Scan for vulnerabilities
security-checker poetry.lock
```

### From Pipenv to Poetry

```bash
# 1. Export Pipfile dependencies
pipenv requirements > requirements.txt

# 2. Follow "From requirements.txt to Poetry" steps above
```

## Summary

The security-checker tool now provides **complete Python support** with:
- ✅ Full transitive dependency resolution via `poetry.lock` and `Pipfile.lock`
- ✅ OSV.dev integration for comprehensive vulnerability data
- ✅ Smart lock file prioritization
- ✅ Detailed vulnerability reports with CVE IDs and remediation advice
- ✅ CI/CD-ready JSON output
- ✅ Support for Poetry, Pipenv, and pip projects

For the best security coverage, always use lock files (`poetry.lock` or `Pipfile.lock`) rather than `requirements.txt` alone.
